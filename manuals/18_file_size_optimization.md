# 18. ファイルサイズ最適化と 413 エラー対策

## 概要

前回コミット（ebb3ed7 "improve recording"）から現在までに、音声ファイルのサイズ制限による 413 エラー（Content Too Large）を解決するための包括的な対策を実装しました。

## 問題の背景

Vercel の無料プランでは、API リクエストのサイズに制限があり、大きな音声ファイルを送信すると 413 エラーが発生していました。長時間の録音により、音声ファイルが 4MB を超えることが原因でした。

## 実装した対策

### 1. API 側のファイルサイズ制限

#### 変更ファイル: `src/app/api/transcribe/route.ts`

**追加内容**:

- 4MB のファイルサイズ制限を追加
- 詳細なエラーハンドリング
- ユーザーフレンドリーなエラーメッセージ

```typescript
// ファイルサイズ制限（4MB）
const MAX_FILE_SIZE = 4 * 1024 * 1024; // 4MB

// ファイルサイズチェック
if (audioFile.size > MAX_FILE_SIZE) {
  return NextResponse.json(
    {
      error: `ファイルサイズが大きすぎます。最大${MAX_FILE_SIZE / (1024 * 1024)}MBまで対応しています。`,
    },
    { status: 413 }
  );
}
```

#### 変更ファイル: `src/app/api/whisper/route.ts`

**追加内容**:

- 同様の 4MB 制限を追加
- OpenAI API のエラーレスポンス詳細ハンドリング

### 2. フロントエンド側の事前チェック

#### 変更ファイル: `src/apis/transcrible-api.ts`

**追加内容**:

- API 送信前のファイルサイズチェック
- 詳細なエラーメッセージの表示

```typescript
// ファイルサイズチェック
if (request.audio.size > MAX_FILE_SIZE) {
  return [
    {
      start: timestamp,
      text: `音声ファイルが大きすぎます（${(request.audio.size / (1024 * 1024)).toFixed(1)}MB）。最大4MBまで対応しています。`,
    },
  ];
}
```

#### 変更ファイル: `src/apis/whisper-api.ts`

**追加内容**:

- 同様の事前チェック機能
- エラーレスポンスの詳細処理

### 3. 録音機能の改善

#### 変更ファイル: `src/lib/recorder.ts`

**追加内容**:

- 録音中のリアルタイムサイズ監視
- 自動停止機能（3.5MB 制限）
- ファイルサイズ警告機能

```typescript
private maxSize: number = 3.5 * 1024 * 1024; // 3.5MB制限

// ファイルサイズをチェック
const totalSize = this.chunks.reduce((sum, chunk) => sum + chunk.size, 0);
if (totalSize > this.maxSize) {
  console.warn("録音ファイルが大きくなりすぎました。自動停止します。");
  this.stop();
}
```

### 4. 録音時間設定の最適化

#### 変更ファイル: `src/lib/storage.ts`

**変更内容**:

- より短い録音間隔オプションを追加
- デフォルト値を短縮

```typescript
export const intervalSecMap1: Record<string, string> = {
  "3": "3秒", // 新規追加
  "5": "5秒",
  "10": "10秒",
  "30": "30秒",
  "60": "60秒",
};

export const intervalSecMap2: Record<string, string> = {
  "30": "30秒", // 新規追加
  "60": "60秒",
  "120": "120秒", // 新規追加
  "300": "300秒",
  "600": "600秒",
};

// デフォルト値を短縮
export function getIntervalSec2(): number {
  return parseInt(localStorage.getItem("intervalSec2") || "120"); // 300 → 120
}
```

### 5. UI/UX の改善

#### 変更ファイル: `src/containers/header/note-dialog.tsx`

**変更内容**:

- 英語化対応（UI テキストのみ）
- コメントは日本語のまま保持

#### その他の UI 改善

- エラーメッセージの改善
- ファイルサイズ警告の表示
- より詳細なステータス表示

## 技術的な改善点

### 1. エラーハンドリングの強化

- **事前チェック**: API 送信前のファイルサイズ検証
- **詳細エラー**: 具体的なサイズ情報を含むエラーメッセージ
- **自動停止**: サイズ制限に達した場合の自動録音停止

### 2. パフォーマンスの向上

- **リアルタイム監視**: 録音中の継続的なサイズチェック
- **早期停止**: 制限に達した場合の即座の停止
- **メモリ効率**: 適切なメモリ管理

### 3. ユーザビリティの改善

- **短い録音間隔**: より細かい音声認識
- **柔軟な設定**: 用途に応じた録音時間選択
- **明確なフィードバック**: サイズ制限の事前通知

## 設定推奨値

### 一般的な使用シーン

- **短い会話**: 3-5 秒間隔、30-60 秒最大
- **通常の会話**: 5-10 秒間隔、120 秒最大
- **長い説明**: 10-30 秒間隔、300 秒最大

### ファイルサイズ目安

- **3 秒録音**: 約 100-200KB
- **30 秒録音**: 約 1-2MB
- **120 秒録音**: 約 4-6MB（制限に近い）

## 今後の拡張予定

1. **音声圧縮**: より効率的な音声形式への変換
2. **ストリーミング**: リアルタイム音声認識
3. **分割処理**: 大きなファイルの自動分割
4. **品質調整**: 音質とファイルサイズのバランス調整

## 注意事項

- 録音時間を短く設定することで、ファイルサイズを制御できます
- 3.5MB を超える録音は自動的に停止されます
- 音声品質は維持しつつ、ファイルサイズを最適化しています
- Vercel の制限内で動作するよう設計されています

## トラブルシューティング

### よくある問題

1. **録音が途中で止まる**

   - ファイルサイズ制限に達した可能性
   - 録音時間を短く設定してください

2. **音声認識エラーが頻発する**

   - ファイルサイズが大きすぎる可能性
   - より短い間隔で録音してください

3. **API 制限エラー**
   - 録音時間を短縮してください
   - 音声品質を下げることを検討してください
