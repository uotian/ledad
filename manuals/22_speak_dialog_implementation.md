# 音声再生ダイアログの実装

## 概要

前回のコミット（0556fb8）から今回のコミット（27f7b97）までの変更で、音声再生機能を備えたダイアログコンポーネントを実装しました。

## 主な変更点

### 1. 新規ファイルの追加

#### `src/apis/speak-api.ts`

- 音声合成APIのクライアント関数を実装
- テキストと音声設定を受け取り、base64エンコードされた音声データを返す

#### `src/containers/main/speak/` ディレクトリ

- **`button.tsx`**: 音声再生ボタンコンポーネント
- **`dialog.tsx`**: 音声再生確認ダイアログ（メイン機能）

### 2. 既存ファイルの変更

#### `src/containers/main/message.tsx`

- メッセージ表示に音声再生ボタンを追加
- original と translation の両方にスピーカーボタンを配置
- `SpeakerButton`コンポーネントをインポートして使用

## 実装詳細

### 音声再生ダイアログ（`dialog.tsx`）

#### 主要機能

1. **自動開始**: ダイアログが開くと自動的に音声再生を開始
2. **セグメント表示**: テキストを改行で分割し、各セグメントを個別に表示
3. **リアルタイム状態表示**:
   - ローディング中: 回転する青いアイコン
   - 再生中: 青いスピーカーアイコン
   - 現在のセグメント: 青色のテキスト
4. **制御機能**:
   - START/RESUME: 停止位置から再開または最初から開始
   - RESTART: 常に最初から開始
   - STOP: 一時停止（位置保持）

#### 技術的実装

- **AudioContext API**: ブラウザネイティブの音声再生機能を使用
- **AbortController**: 音声再生の安全な停止機能
- **状態管理**:
  - `currentSegmentIndex`: 現在のセグメント位置
  - `loadingSegments`: ローディング中のセグメント
  - `isPlaying`: 再生状態
- **再開機能**: 停止した位置から再開可能

#### UI/UX設計

- **ダイアログサイズ**: `max-w-7xl`（1280px）で広い表示領域
- **アクセシビリティ**: `sr-only`クラスでスクリーンリーダー対応
- **ボタン配置**:
  - START/RESUME: 青色（再生中は無効）
  - RESTART: アウトライン（再生中は無効）
  - STOP: 赤色（再生中のみ有効）

### 音声再生ボタン（`button.tsx`）

#### 機能

- テキストを受け取り、クリック時に音声再生ダイアログを表示
- スピーカーアイコンで直感的な操作

### API統合（`speak-api.ts`）

#### 実装

- 音声合成APIエンドポイントとの通信
- エラーハンドリングとレスポンス処理
- base64エンコードされた音声データの処理

## 技術的改善点

### 1. 音声再生の制御

- **即座の中断**: `AudioBufferSourceNode`の即座停止
- **定期的な停止チェック**: 100ms間隔で停止フラグをチェック
- **AudioContext管理**: 適切なリソース管理とクリーンアップ

### 2. 状態管理の最適化

- **再開位置の保持**: 停止時に位置を記憶
- **条件付き自動開始**: 一時停止中は自動開始しない
- **エラー処理**: 停止による中断とエラーを区別

### 3. アクセシビリティ対応

- **スクリーンリーダー対応**: 非表示タイトルの追加
- **キーボードナビゲーション**: 適切なフォーカス管理
- **視覚的フィードバック**: 状態に応じたアイコンと色の変更

## 使用方法

### 基本的な使用

1. メッセージのスピーカーボタンをクリック
2. 音声再生ダイアログが開き、自動的に再生開始
3. 必要に応じてSTOP/RESUME/RESTARTボタンで制御

### 制御オプション

- **一時停止**: STOPボタンで停止（位置保持）
- **再開**: RESUMEボタンで停止位置から再開
- **最初から**: RESTARTボタンで最初から再開
- **完了**: ダイアログを閉じると完了状態に

## 今後の改善案

1. **音声品質設定**: 音声の速度やピッチの調整
2. **バッファリング表示**: 音声データの読み込み進捗
3. **キーボードショートカット**: スペースキーでの再生/停止
4. **音声波形表示**: リアルタイムの音声波形表示
5. **複数音声対応**: 異なる音声での再生オプション

## 関連ファイル

- `src/containers/main/speak/dialog.tsx` - メインの音声再生ダイアログ
- `src/containers/main/speak/button.tsx` - 音声再生ボタン
- `src/apis/speak-api.ts` - 音声合成APIクライアント
- `src/containers/main/message.tsx` - メッセージ表示（音声ボタン統合）
