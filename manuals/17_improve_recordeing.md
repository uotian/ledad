# 包括的アップデート - 前回コミットからの変更点

## 概要

前回コミットから現在までに、アプリケーション全体に大幅な改善と新機能が実装されました。主な変更点は以下の通りです：

## 主要な変更カテゴリ

### 1. メッセージ表示システムの改善

### 2. 録音システムの完全リファクタリング

### 3. 言語切り替え機能の追加

### 4. 設定機能の拡張

### 5. API 機能の強化

### 6. UI/UX の改善

### 7. 開発環境の整備

## 詳細な変更点

### 1. メッセージ表示システムの改善

#### 変更ファイル: `src/containers/main/message.tsx`

- **折りたたみ機能の実装**: HTML の`<details>`と`<summary>`タグを使用
- **原文と翻訳の分離表示**: 個別に折りたたみ可能
- **デフォルトで開いた状態**: `open`属性により初期表示
- **スタイリングの改善**: ホバーエフェクトとトランジション追加

#### 変更ファイル: `src/containers/main/index.tsx`

- **メッセージ取得方法の変更**: `getMessageMap()`から`getMessages()`に変更
- **ソート処理の最適化**: タイムスタンプベースのソートに変更

#### 変更ファイル: `src/lib/types.ts`

- **Message 型の大幅変更**:
  ```typescript
  export interface Message {
    user: string;
    timestamp: number; // 新規追加
    text?: string; // オプショナルに変更
    translated?: string;
    status?: // 詳細なステータス追加
    | "recording"
      | "converting"
      | "translating"
      | "success"
      | "recording error"
      | "converting error"
      | "translating error"
      | "completing error"
      | "error"
      | "completed";
  }
  ```

### 2. 録音システムの完全リファクタリング

#### 新規ファイル: `src/lib/recorder.ts`

- **クラスベースのレコーダー**: 従来のカスタムフックから変更
- **Promise ベースの処理**: より安定した非同期処理
- **リソース管理の改善**: 適切なメモリ解放

#### 削除ファイル: `src/hooks/use-recorder.ts`

- 従来のカスタムフックを削除

#### 変更ファイル: `src/containers/footer/mic-input.tsx`

- **二重録音システム**: 速報録音と最終録音の分離
- **タイマー機能**: `react-timer-hook`を使用
- **録音間隔の設定**: 速報間隔と最大間隔の分離
- **エラーハンドリングの強化**: 詳細なエラー状態管理

### 3. 言語切り替え機能の追加

#### 新規ファイル: `src/containers/header/actions/lang.tsx`

- **ドロップダウンメニュー**: 言語選択 UI
- **ブラウザ言語の自動検出**: 初期言語の自動設定
- **SSR 対応**: サーバーサイドレンダリング時の適切な処理

#### 変更ファイル: `src/lib/storage.ts`

- **言語設定機能の追加**:
  ```typescript
  export function getLang(): string;
  export function setLang(value: string): void;
  ```

### 4. 設定機能の拡張

#### 変更ファイル: `src/containers/header/actions/setting-dialog.tsx`

- **録音間隔設定の分離**: 速報間隔と最大間隔の個別設定
- **UI レイアウトの改善**: より直感的な配置
- **説明文の追加**: 各設定項目の説明

#### 変更ファイル: `src/lib/storage.ts`

- **録音間隔設定の拡張**:

  ```typescript
  export const intervalSecMap1: Record<string, string> = {
    "5": "5秒",
    "10": "10秒",
    "30": "30秒",
    "60": "60秒",
  };

  export const intervalSecMap2: Record<string, string> = {
    "60": "60秒",
    "300": "300秒",
    "600": "600秒",
  };
  ```

### 5. API 機能の強化

#### 変更ファイル: `src/app/api/chat/route.ts`

- **チャット履歴の返却**: レスポンスにチャット履歴を含める
- **メッセージ構造の改善**: より詳細なコンテキスト管理

#### 変更ファイル: `src/app/api/transcribe/route.ts`

- **JSON 形式での応答**: `response_format: "json"`の追加

#### 変更ファイル: `src/app/api/whisper/route.ts`

- **詳細な音声認識結果**: `response_format: "verbose_json"`の追加
- **セグメント情報の取得**: 時間情報付きの認識結果

#### 変更ファイル: `src/apis/transcrible-api.ts`, `src/apis/whisper-api.ts`

- **API 応答形式の対応**: 新しい JSON 形式への対応

### 6. UI/UX の改善

#### 変更ファイル: `src/containers/header/actions/index.tsx`

- **言語切り替えボタンの追加**: ヘッダーに言語選択機能
- **SSR 対応の改善**: マウント状態の管理

#### 変更ファイル: `src/containers/header/note-dialog.tsx`

- **フォーカス管理の改善**: テキストエリアの自動フォーカス
- **ルーム変更時の対応**: チャット履歴の動的更新
- **説明文の追加**: ダイアログの説明

#### 変更ファイル: `src/containers/header/room-dialog.tsx`

- **説明文の追加**: ルーム管理ダイアログの説明
- **チャット履歴管理の改善**: ルーム削除時の履歴削除

#### 変更ファイル: `src/containers/footer/text-input.tsx`

- **タイムスタンプの追加**: メッセージにタイムスタンプを追加
- **ステータス管理の改善**: より詳細なステータス表示

### 7. 開発環境の整備

#### 新規ファイル: `.vscode/extensions.json`

- **推奨拡張機能**: 開発に必要な拡張機能の設定

#### 新規ファイル: `.vscode/launch.json`

- **デバッグ設定**: VS Code でのデバッグ環境

#### 変更ファイル: `package.json`

- **新しい依存関係の追加**:
  ```json
  {
    "react-timer-hook": "^4.0.5",
    "react-use": "^17.6.0"
  }
  ```

## 技術的な改善点

### 1. パフォーマンスの向上

- メッセージソートの最適化
- メモリ管理の改善
- 非同期処理の最適化

### 2. エラーハンドリングの強化

- 詳細なエラー状態の管理
- ユーザーフレンドリーなエラー表示
- 適切なフォールバック処理

### 3. アクセシビリティの改善

- ネイティブ HTML 要素の活用
- キーボードナビゲーションの対応
- スクリーンリーダー対応

### 4. コード品質の向上

- TypeScript 型の改善
- 関数の分離と再利用性の向上
- コメントとドキュメントの追加

## 新機能の詳細

### 1. メッセージ折りたたみ機能

- HTML の`<details>`と`<summary>`タグを使用
- JavaScript 不要で軽量
- アクセシビリティに優れた実装

### 2. 二重録音システム

- 速報録音: 短い間隔での音声認識
- 最終録音: 長い間隔での最終認識
- 設定可能な録音間隔

### 3. 言語切り替え機能

- ドロップダウンメニューでの言語選択
- ブラウザ言語の自動検出
- 設定の永続化

### 4. 強化された設定機能

- 録音間隔の詳細設定
- より直感的な UI
- 設定項目の説明

## 今後の拡張可能性

1. **音声品質の改善**: より高品質な音声録音
2. **リアルタイム処理**: ストリーミング音声認識
3. **多言語対応**: 同時多言語音声認識
4. **設定のカスタマイズ**: より詳細な設定オプション
5. **パフォーマンス最適化**: さらなる高速化

## 関連する変更

このアップデートは以下の要素と連携しています：

- メッセージ表示システム
- 録音・音声認識システム
- 翻訳システム
- 設定管理システム
- UI/UX システム
- 開発環境

## まとめ

今回のアップデートにより、アプリケーションはより使いやすく、安定した、機能豊富なシステムとなりました。特に録音システムの改善とメッセージ表示の向上により、ユーザー体験が大幅に向上しています。
