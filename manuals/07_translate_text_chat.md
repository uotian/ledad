# 07. チャット機能の実装

## 概要

このコミットでは、HooTalk アプリケーションに完全なチャット機能を実装しました。翻訳機能付きのメッセージングシステム、リアルタイム更新、メッセージ管理機能を含む包括的なチャット機能を追加しています。

## 主な変更点

### 1. データ管理の拡張 (`src/app/local-storages.ts`)

#### 新規追加

- **Message 型定義**: メッセージの構造を定義

  ```typescript
  export interface Message {
    user: number;
    text: string;
    translated: string;
    datetime: string;
  }
  ```

- **言語設定の統合**: `langMap`を追加して言語設定を一元管理

- **メッセージ管理関数**:
  - `getMessages()`: ローカルストレージからメッセージを取得
  - `setMessages()`: メッセージをローカルストレージに保存
  - `addMessage()`: 新しいメッセージを追加（自動的にタイムスタンプ付与）
  - `clearMessages()`: すべてのメッセージを削除

### 2. メインコンテンツの分離 (`src/app/page.tsx`)

#### 変更内容

- スケルトンコンポーネントを削除
- 実際の機能コンポーネントに置き換え:
  - `<Main />`: メッセージ表示エリア
  - `<Footer />`: メッセージ入力エリア

### 3. メインコンテンツコンテナ (`src/containers/main/`)

#### 新規ファイル

- **`index.tsx`**: メインコンテンツの管理

  - メッセージの状態管理
  - リアルタイム更新（カスタムイベント対応）
  - 自動スクロール機能
  - メッセージがない場合の表示

- **`message.tsx`**: 個別メッセージの表示

  - ユーザーメッセージと受信メッセージの区別
  - タイムスタンプ表示
  - 原文と翻訳文の表示
  - レスポンシブデザイン

- **`nodata.tsx`**: メッセージがない場合の表示

### 4. フッターコンテナ (`src/containers/footer/`)

#### 新規ファイル

- **`index.tsx`**: フッターのレイアウト

  - 固定位置での表示
  - 入力エリアとアクションアイコンの配置

- **`input.tsx`**: メッセージ入力機能
  - リアルタイム翻訳機能
  - 日本語入力対応（IME 合成対応）
  - 翻訳状態の視覚的フィードバック
  - エラーハンドリング

### 5. API 機能 (`src/app/api/`)

#### 新規ファイル

- **`translate/route.ts`**: 翻訳 API エンドポイント

  - OpenAI GPT-4o-mini を使用した翻訳
  - システムプロンプトによる高品質翻訳
  - エラーハンドリングとレスポンス管理

- **`translate/access.ts`**: 翻訳 API クライアント

  - フロントエンドからの API 呼び出し
  - 型安全なインターフェース

- **`speak/route.ts`**: 音声合成 API（将来の拡張用）

### 6. ヘッダー機能の拡張

#### 変更ファイル

- **`src/containers/header/actions/index.tsx`**: ゴミ箱ボタンを追加
- **`src/containers/header/info.tsx`**: 軽微な調整

#### 新規ファイル

- **`src/containers/header/actions/trash.tsx`**: メッセージ削除機能
  - 確認ダイアログ付きの削除機能
  - アクセシビリティ対応

## 技術的特徴

### 1. リアルタイム更新

- カスタムイベント（`messages`）による即座の更新
- ローカルストレージの変更監視
- 自動スクロール機能

### 2. 翻訳機能

- OpenAI API を使用した高品質翻訳
- リアルタイム翻訳（入力中に翻訳実行）
- エラーハンドリングとユーザーフィードバック

### 3. ユーザーエクスペリエンス

- 日本語入力（IME）対応
- 視覚的フィードバック（ローディング状態）
- レスポンシブデザイン
- アクセシビリティ対応

### 4. データ永続化

- ローカルストレージによるメッセージ保存
- 型安全なデータ管理
- 効率的な状態管理

## ファイル構造の変更

```
src/
├── app/
│   ├── api/
│   │   ├── speak/
│   │   │   └── route.ts (新規)
│   │   └── translate/
│   │       ├── access.ts (新規)
│   │       └── route.ts (新規)
│   ├── local-storages.ts (大幅変更)
│   └── page.tsx (大幅変更)
├── containers/
│   ├── footer/ (新規ディレクトリ)
│   │   ├── index.tsx (新規)
│   │   └── input.tsx (新規)
│   ├── header/
│   │   └── actions/
│   │       ├── index.tsx (軽微変更)
│   │       ├── info.tsx (軽微変更)
│   │       └── trash.tsx (新規)
│   └── main/ (新規ディレクトリ)
│       ├── index.tsx (新規)
│       ├── message.tsx (新規)
│       └── nodata.tsx (新規)
```

## 今後の拡張予定

1. **音声合成機能**: `speak/route.ts`の実装
2. **メッセージ検索機能**: 過去のメッセージ検索
3. **メッセージエクスポート**: チャット履歴の保存
4. **リアルタイム通信**: WebSocket によるリアルタイムチャット
5. **ファイル添付機能**: 画像やファイルの送信

## 注意事項

- OpenAI API キーの環境変数設定が必要
- ローカルストレージの容量制限に注意
- 翻訳 API の利用制限に注意
- ブラウザの互換性確認が必要
